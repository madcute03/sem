#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Install PHP dependencies
composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

# Install Node.js dependencies and build assets
npm ci && npm run build

# Generate application key if not exists
if [ ! -f .env ]; then
    cp .env.example .env
    php artisan key:generate
fi

# Run database migrations
php artisan migrate --force

# Clear all caches
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan event:cache
php artisan cache:clear

# Create storage link if it doesn't exist
if [ ! -L public/storage ]; then
    php artisan storage:link
fi

# Set proper permissions
chmod -R 775 storage bootstrap/cache

# Start the server
exec php artisan serve --host=0.0.0.0 --port=${PORT:-8000}