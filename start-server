#!/bin/bash
set -e

echo "=== Starting Application Server ==="
echo "Current directory: $(pwd)"
echo "Node version: $(node -v)"
echo "NPM version: $(npm -v)"
echo "PHP version: $(php -v | head -n 1)"
echo "Composer version: $(composer --version)"

# Install PHP dependencies
echo "=== Installing PHP Dependencies ==="
composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

# Install Node.js dependencies and build assets
echo "=== Installing Node.js Dependencies ==="
npm ci --production=false

# Build assets
echo "=== Building Assets ==="
npm run build

# Generate application key if not exists
if [ ! -f .env ]; then
    echo "=== Copying .env.example to .env ==="
    cp .env.example .env
    php artisan key:generate
fi

# Run database migrations
echo "=== Running Database Migrations ==="
php artisan migrate --force

# Clear all caches
echo "=== Optimizing Application ==="
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan event:cache
php artisan cache:clear

# Create storage link if it doesn't exist
if [ ! -L public/storage ]; then
    echo "=== Creating Storage Link ==="
    php artisan storage:link
fi

# Set proper permissions
echo "=== Setting Permissions ==="
chmod -R 775 storage bootstrap/cache

# Start the server
echo "=== Starting Application ==="
exec php artisan serve --host=0.0.0.0 --port=${PORT:-8000}